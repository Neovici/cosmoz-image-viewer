<!doctype html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
	<title>cosmoz-image-viewer basic test</title>

	<script src="/components/@webcomponents/webcomponentsjs/webcomponents-bundle.js"></script>
	<script src="/components/mocha/mocha.js"></script>
	<script src="/components/wct-mocha/wct-mocha.js"></script>
	<script src="/components/chai/chai.js"></script>
	<script src="/components/sinon/pkg/sinon.js"></script>
	<script src="/components/@polymer/test-fixture/test-fixture-mocha.js"></script>
	<script src="/components/resize-observer-polyfill/dist/ResizeObserver.js"></script>

	<script type="module" src="/components/@polymer/test-fixture/test-fixture.js"></script>
	<script type="module" src="/components/@polymer/iron-test-helpers/iron-test-helpers.js"></script>

	<script type="module" src="../lib/haunted-pan-zoom.js"></script>

	<style>
		body {
			margin: 0;
		}

		haunted-pan-zoom {
			width: 200px;
			height: 200px;
		}
	</style>
</head>
<body>
	<test-fixture id="basic">
		<template>
			<haunted-pan-zoom src="../demo/images/cosmos1.jpg" zoom-stiffness="1"></haunted-pan-zoom>
		</template>
	</test-fixture>

	<script type="module">
		import {cycle, assertFuzzyMatch} from './helpers';

		const status = (el, status) => new Promise(resolve => el.addEventListener('status-changed', ({ detail: {value} }) => value === status && resolve()));
		const loaded = el => status(el, 'loaded');
		const error = el => status(el, 'error');

		const scroll = (el, dir) => el.shadowRoot.querySelector('.container').dispatchEvent(new WheelEvent('wheel', {deltaY: dir}));
		const scrollDown = el => scroll(el, 1);
		const scrollUp = el => scroll(el, -1);

		// eslint-disable-next-line max-lines-per-function
		describe('haunted-pan-zoom', () => {
			let el;

			beforeEach(async () => {
				el = fixture('basic');
				await loaded(el);
			});

			it('displays the image centered', () => {
				const img = el.shadowRoot.querySelector('img');
				assert.include(img.src, 'demo/images/cosmos1.jpg');
				assertFuzzyMatch(img.getBoundingClientRect(), { top: 43.75, left: 0, width: 200, height: 112.5 });
			});

			it('handles errors', async () => {
				el.src = 'missing.jpg';

				await error(el);
				const img = el.shadowRoot.querySelector('img');
				assert.notExists(img);
			});

			it('changing src changes the image and centers it', async () => {
				el.src = '../demo/images/cosmos2.jpg';

				await loaded(el);

				const img = el.shadowRoot.querySelector('img');
				assert.include(img.src, 'demo/images/cosmos2.jpg');
				assertFuzzyMatch(img.getBoundingClientRect(), { top: 0, left: 0, width: 200, height: 200 });
			});

			it('handles scroll events', async () => {
				const img = el.shadowRoot.querySelector('img');

				scrollUp(el);
				await cycle();

				assertFuzzyMatch(img.getBoundingClientRect(), { top: -0.9, left: -79.5, width: 359, height: 201.94});

				scrollDown(el);
				await cycle();

				assertFuzzyMatch(img.getBoundingClientRect(), { top: 43.75, left: 0, width: 200, height: 112.5 });
			});

			it('handles mouse panning', async () => {
				const img = el.shadowRoot.querySelector('img');

				scrollUp(el);
				await cycle();

				assertFuzzyMatch(img.getBoundingClientRect(), { top: -0.9, left: -79.5, width: 359, height: 201.94});

				scrollDown(el);
				await cycle();

				assertFuzzyMatch(img.getBoundingClientRect(), { top: 43.75, left: 0, width: 200, height: 112.5 });
			});

		});
	</script>
</body>
</html>
